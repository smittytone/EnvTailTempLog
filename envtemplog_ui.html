<!DOCTYPE html>
<html lang='en-US'>
<head>
  <title>Environment Data</title>
  <link rel='stylesheet' href='https://netdna.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300' rel='stylesheet'>
  <link rel='apple-touch-icon' href='https://smittytone.github.io/images/ati-tsensor.png'>
  <link rel='shortcut icon' href='https://smittytone.github.io/images/ico-tsensor.ico' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <meta charset='UTF-8'>
  <style>
    .center {margin-left: auto; margin-right: auto; margin-bottom: auto; margin-top: auto;}
    .uicontent {border: 2px solid white;}
    .container {padding: 20px;}

    body {background-color: #3366cc;}
    p {color: white; font-family: Open Sans Condensed, sans-serif; font-size: 16px; margin-top:0px;
       font-size: 0.9em;}
    p.colophon {font-family: Open Sans Condensed, sans-serif; font-size: 0.8em;}
    p.input {color: black;}
    h2 {color: #99ccff; font-family: Open Sans Condensed, sans-serif; font-weight:bold; margin-top:18px;}
    h4 {color: white; font-family: Open Sans Condensed, sans-serif;}
    td {color: white; font-family: Open Sans Condensed, sans-serif;}
    a:link {color: white; font-family: Open Sans Condensed, sans-serif; text-decoration: underline;}
    a:visited {color: #cccccc; font-family: Open Sans Condensed, sans-serif; text-decoration: underline;}
    a:hover {color: black; font-family: Open Sans Condensed, sans-serif;}
    a:active {color: black; font-family: Open Sans Condensed, sans-serif;}

    @media only screen and (max-width: 640px) {
      .container {padding: 5px}
      .uicontent {border: 0px}
    }
  </style>
</head>
<body>
  <div class='container'>
    <div class='row uicontent' align='center'>
      <div class='col'>
        <h2 class='name-status'>Environment Data <span></span></h2>
        <h4 class='temp-status'>Current Temperature: <span></span>&deg;C</h4>
        <h4 class='humid-status'>Current Humidity: <span></span> per cent</h4>
        <h4 class='locale-status'>Sensor Location: <span></span></h4>
        <p class='timestamp'>&nbsp;<br>Last reading: <span></span></p>
        <p><small>Contemporary chart data at <a href='%s' target='_blank'>freeboard.io</a></small></p>
        <br>
        <div class='controls-area' align='center'>
          <form id='name-form'>
            <div class='update-button'>
              <p>Update Sensor Name <input id='location' style='color:black;height:38px;vertical-align:middle;'></input>
              <button class='btn btn-light'
              style='color:dimGrey;font-family:Open Sans Condensed,sans-serif;vertical-align:middle;'
              type='submit' id='location-button'>Set Name</button></p>
            </div>
            <div class='debug-checkbox' style='color:white;font-family:Open Sans Condensed'>
              <input type='checkbox' name='debug' id='debug' value='debug'> Debug Mode
            </div>
          </form>
        </div>
        <p>&nbsp;</p>
        <p class='colophon'>Environment Data &copy; Tony Smith, 2014-17<br>
        <a href='https://github.com/smittytone/EnvTailTempLog'>
        <img src='https://smittytone.github.io/images/rassilon.png' width='32' height='32'></a></p>
      </div>
    </div>
  </div>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
  <script>
    var agenturl = '%s';

    getState(updateReadout);

    $('.update-button button').click(getStateInput);
    $('#debug').click(setdebug);

    function getStateInput(e){
      e.preventDefault();
      var place = document.getElementById('location').value;
      setName(place);
      $('#name-form').trigger('reset');
    }

    function updateReadout(data) {
      $('.temp-status span').text(data.temp);
      $('.humid-status span').text(data.humid);
      $('.locale-status span').text(data.locale);

      if (data.name === '') {
        $('.name-status span').text('');
      } else {
        $('.name-status span').text('(' + data.name + ')');
      }

      var date = new Date();
      $('.timestamp span').text(date.toTimeString());

      document.getElementById('debug').checked = data.debug;

      setTimeout(function() {
        getState(updateReadout);
      }, 120000);
    }

    function getState(callback) {
      $.ajax({
        url : agenturl + '/state',
        type: 'GET',
        success : function(response) {
          if (callback) {
            callback(response);
          }
        },
        cache: false
      });
    }

    function setName(name) {
      // Set the sensor name
      $.ajax({
        url : agenturl + '/name',
        type: 'POST',
        data: JSON.stringify({ 'name' : name }),
        success : function(response) {
          if ('name' in response) {
            $('.name-status span').text(response.name);
          }
        },
        cache: false
      });
    }

    function setdebug() {
      // Tell the device to enter or leave debug mode
      $.ajax({
        url : agenturl + '/debug',
        type: 'POST',
        data: JSON.stringify({ 'debug' : document.getElementById('debug').checked }),
        cache: false
      });
    }
  </script>
</body>
</html>
